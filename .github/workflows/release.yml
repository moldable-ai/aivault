name: Release

on:
  push:
    tags:
      - "cli-v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (cli-vX.Y.Z)"
        required: true
        type: string
      draft:
        description: "Create as draft release"
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      tag: ${{ steps.vars.outputs.tag }}
      version: ${{ steps.vars.outputs.version }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve tag
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          if ! printf '%s' "$TAG" | grep -Eq '^cli-v[0-9]+\.[0-9]+\.[0-9]+([-.][0-9A-Za-z.-]+)?$'; then
            echo "Invalid tag '$TAG'. Expected cli-vX.Y.Z (optional prerelease/build suffix)." >&2
            exit 1
          fi
          VERSION="${TAG#cli-v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: aivault v${{ steps.vars.outputs.version }}
          draft: ${{ github.event_name == 'workflow_dispatch' && inputs.draft || false }}
          prerelease: false
          generate_release_notes: true

  build:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-14
            target: aarch64-apple-darwin
          - platform: macos-14
            target: x86_64-apple-darwin
          - platform: ubuntu-latest
            target: x86_64-unknown-linux-gnu
    runs-on: ${{ matrix.platform }}
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.tag }}
          fetch-depth: 0

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          targets: ${{ matrix.target }}

      - name: Build (release)
        run: |
          cargo build --release --locked --all-features --target ${{ matrix.target }} --bin aivault --bin aivaultd

      - name: Package (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/aivault dist/aivault
          cp target/${{ matrix.target }}/release/aivaultd dist/aivaultd
          chmod +x dist/aivault dist/aivaultd

      - name: Sign binaries (macOS)
        if: startsWith(matrix.platform, 'macos')
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail
          if [ -z "${APPLE_CERTIFICATE:-}" ] || [ -z "${APPLE_CERTIFICATE_PASSWORD:-}" ] || [ -z "${APPLE_SIGNING_IDENTITY:-}" ]; then
            echo "Missing Apple signing secrets (APPLE_CERTIFICATE/APPLE_CERTIFICATE_PASSWORD/APPLE_SIGNING_IDENTITY)"
            exit 1
          fi

          KEYCHAIN_NAME="aivault-signing-$RANDOM"
          KEYCHAIN_PATH="$HOME/Library/Keychains/$KEYCHAIN_NAME.keychain-db"
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          CERT_PATH=$(mktemp).p12
          echo "$APPLE_CERTIFICATE" | base64 -d > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_PATH"

          security import "$CERT_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychain -d user | tr -d '"')

          for bin in dist/aivault dist/aivaultd; do
            codesign --force --sign "$APPLE_SIGNING_IDENTITY" --options runtime --timestamp --keychain "$KEYCHAIN_PATH" "$bin"
          done

          rm -f "$CERT_PATH"
          security delete-keychain "$KEYCHAIN_PATH"

      - name: Zip + checksums (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          cd dist
          zip -r "../aivault-${{ matrix.target }}.zip" aivault aivaultd
          shasum -a 256 "../aivault-${{ matrix.target }}.zip" > "../aivault-${{ matrix.target }}.zip.sha256"

      - name: Notarize zip (macOS)
        if: startsWith(matrix.platform, 'macos')
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          if [ -z "${APPLE_ID:-}" ] || [ -z "${APPLE_PASSWORD:-}" ] || [ -z "${APPLE_TEAM_ID:-}" ]; then
            echo "Missing Apple notarization secrets (APPLE_ID/APPLE_PASSWORD/APPLE_TEAM_ID)"
            exit 1
          fi
          xcrun notarytool submit "aivault-${{ matrix.target }}.zip" --apple-id "$APPLE_ID" --password "$APPLE_PASSWORD" --team-id "$APPLE_TEAM_ID" --wait

      - name: Package (Linux)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/aivault dist/aivault
          cp target/${{ matrix.target }}/release/aivaultd dist/aivaultd
          chmod +x dist/aivault dist/aivaultd
          tar -czf "aivault-${{ matrix.target }}.tar.gz" -C dist aivault aivaultd
          sha256sum "aivault-${{ matrix.target }}.tar.gz" > "aivault-${{ matrix.target }}.tar.gz.sha256"

      - name: Install cosign (Linux)
        if: matrix.platform == 'ubuntu-latest'
        uses: sigstore/cosign-installer@v3

      - name: Sign artifact (Linux, cosign keyless)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          set -euo pipefail
          cosign sign-blob --yes \
            --output-certificate "aivault-${{ matrix.target }}.tar.gz.cert" \
            --output-signature "aivault-${{ matrix.target }}.tar.gz.sig" \
            "aivault-${{ matrix.target }}.tar.gz"

      - name: Upload artifacts to release (macOS)
        if: startsWith(matrix.platform, 'macos')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.tag }}
          files: |
            aivault-${{ matrix.target }}.zip
            aivault-${{ matrix.target }}.zip.sha256

      - name: Upload artifacts to release (Linux)
        if: matrix.platform == 'ubuntu-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.tag }}
          files: |
            aivault-${{ matrix.target }}.tar.gz
            aivault-${{ matrix.target }}.tar.gz.sha256
            aivault-${{ matrix.target }}.tar.gz.cert
            aivault-${{ matrix.target }}.tar.gz.sig

  publish-crate:
    needs: [create-release, build]
    if: ${{ github.event_name != 'workflow_dispatch' || !inputs.draft }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.tag }}
          fetch-depth: 0

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0

      - name: Validate crate version matches release tag
        run: |
          set -euo pipefail
          TAG_VERSION="${{ needs.create-release.outputs.version }}"
          CARGO_VERSION="$(sed -n 's/^version = "\(.*\)"/\1/p' Cargo.toml | head -n1)"
          if [ -z "$CARGO_VERSION" ]; then
            echo "Could not resolve version from Cargo.toml" >&2
            exit 1
          fi
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "Cargo.toml version ($CARGO_VERSION) does not match release tag version ($TAG_VERSION)." >&2
            exit 1
          fi

      - name: Check whether crate version already exists on crates.io
        id: crates_state
        run: |
          set -euo pipefail
          VERSION="${{ needs.create-release.outputs.version }}"
          STATUS="$(curl -sS -o /tmp/crates-response.json -w '%{http_code}' "https://crates.io/api/v1/crates/aivault/$VERSION")"
          if [ "$STATUS" = "200" ]; then
            echo "already_published=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "$STATUS" = "404" ]; then
            echo "already_published=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Unexpected crates.io status code: $STATUS" >&2
          cat /tmp/crates-response.json >&2 || true
          exit 1

      - name: Publish crate to crates.io
        if: steps.crates_state.outputs.already_published != 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
            echo "Missing required secret: CARGO_REGISTRY_TOKEN" >&2
            exit 1
          fi
          cargo publish --locked

  publish-release:
    needs: [create-release, build, publish-crate]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Publish release
        uses: softprops/action-gh-release@v2
        if: ${{ github.event_name != 'workflow_dispatch' || !inputs.draft }}
        with:
          tag_name: ${{ needs.create-release.outputs.tag }}
          draft: false
